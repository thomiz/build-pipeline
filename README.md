# FHIR build pipeline

 The main goal of this guide is to show how you can generate an implementation guide from FHIR-profiles and other conformance resources defined for your FHIR project. The implementation guide should document how to implement a client and/or a server that is to integrate to your FHIR implementation and what semantic requirements the client/server should conform to.  

 ![FHIR Build Workflow](igs/FHIRbuild/input/images/workflow.png)  

**Profiling** To make a FHIR implementation guide you first have to define the conformance resources that defines the semantic rules of you implementation. This step is called [Profiling](https://www.hl7.org/fhir/profiling.html) and usually produce a number for FHIR conformance resources either in the form of XML/JSON or SUSHI FSH files.  

**Documenting** To make an Implementation Guide readable for humans you have to explain the use-case(s) your implementation supports and how the conformance resources are used to achieve interoperability supporting the use-case(s). This step is called documenting and the end result is usually a number of assets descriping the problem and their solution using your implementation and what conformance resources applies to different use-case(s). The assets are usually images and text that can be structured into a human readable document (usually a number of html pages).  

**Generating** To generate the actual FHIR implementation guide, the FHIR tooling can generate static html pages that consists of all you conformance resources and all the documentation generated in the Documenting step. The end result is a number of html pages that can be published on the internet.

**Testing and QA** The generated FHIR IG should be available as a CI build to be read by human beings and tested in implementations in order to ascertain the quality of the documentation and the proposed conformance resources. The four steps Profiling, Documenting, Generating and Testing and QA could be repeated any number of times before achieving an IG ready for publication.

**Publishing** The finished implementation guide generated and undergoing testing and QA step could then be hosted on you preferred web hosting site as a finished version of the IG. When you have a version of the IG that are ready for release you can publish this as a static version of the IG and register the generated FHIR package in the [FHIR package registry](https://registry.fhir.org/). The Published version of the implementation guides should be hosted on the same url as the defined canonical of the ImplementationGuide.

## Setup repository for a FHIR Implementation guide

This guide describes two ways for building your Implementationguide using HL7 IG publisher. No matter what build process you choose you need to setup a repository for you IG source files.

### Setup your GitHub repo

You will need a gh-pages branch to contain the files produced from you IG build process.  
Goto the Settings->Pages, choose none and press "choose a theme", commit the autogenerated README.md (or edit it first).

>If you add github pages to your repo you have to: 
Choose a theme AND commit the README.md file that is autogenerated by github if Github is to make a separate **gh-pages** branch in your repo.  After this you only have to make the result of the build process available in the gh-pages branch to make this work.

Clone the gh-pages branch to a catalog on your local drive (e.g. "gh-pages") and clone the master branches to a separate directory locally (e.g. "master"). The "gh-pages" catalog is where you store all the files from the IG-generation "output" directory. The "master" directory is where you develop and store the artifacts for your IG and the directory that you point IG-publisher for input files to generate the IG.

### Make an ImplementationGuide

In a separate folder under "igs", define your IG and the FHIR artifacts (profiles, extensions etc.). Artifacts goes in the input folder.  FHIR artifacts can be converted from xml/json to FSH or written by hand using the FSH language.

You need three files to get started with IG build process:
* ig.ini - Defines the template for the IG and where the generated ImplementationGuide resouces is to be found.
* sushi-config.yaml - Defines configuration for your implementation guide to the SUSHI IG generation part of the IG-Publisher
* input/pages/index.md - The starting page of your implementation guide, usually written i markdown
* package-list.json - is recommended to keep track of published versions of your IG

The actual FHIR definitions goes into the fsh folder, full writeup of the catalog structure for [IG-generation](https://fshschool.org/docs/sushi/project/#ig-projects):
* input/fsh/* - All the fsh files defining your FHIR artifacts (profiles, search parameters, codesystems etc.)

XML or JSON input is placed in the input folder with [appropriate folder names](https://build.fhir.org/ig/FHIR/ig-guidance/using-templates.html#igroot-input)  

### Next step

When the source files are written in you IG repository you are ready to run IG publisher and generate an actual FHIR IG. 
* Run the publisher as a Github-workflow
* Run the publisher installation on your local computer (using a docker image is described here)

A third option is to setup a webhook to run the [HL7 auto build process](https://github.com/FHIR/auto-ig-builder)

## Running IG-publisher as a Github-workflow

When we set up a build environment using Github-workflow we make a yaml script that uses several prebuilt tools to build the implementation-guide and deploying this to a github-pages environment for review. We use a HL7 generated docker image containing the FHIR build pipeline that handles any FHIR conformance resources for building a FHIR implementation guide.

### Setup a CI GitHub workflow

To use this build pipeline you have to make a script to run the IG-publisher and other necessarry jobs to build and deploy the Implementation Guide.

### IG build yaml script

The build script is added in the **.github/workflows** directory of your Github repository. When the script is added to the main/master branch of your project it will apear under the **Actions** tab of you repo for manual run and status messages. The script can also be made to run automatically on commits to master or any other automation available through [Github-Actions](https://docs.github.com/en/actions).  
We are using a clone of the auto builder made my [HL7 Belgium](https://github.com/hl7-be/tutorial_ig/blob/master/.github/workflows/main.yml) with some [modifications](https://github.com/HL7Norway/VkpObservation/blob/master/.github/workflows/vkpobservation-gh-pages.yml).  
The script should be self explanatory with ample use of comments to describe the actual workings of the action script.

### Output

The running of the actual build process using the Github action should take 2-10 minutes dependent on the size of the Implementionguide. A successfull/unsuccessful run should be documented under the **Action** tab. The output from the script (the actual html rendered Implementation guide is available as html files in the **gh-pages** branch and can be accessed like this:
* [VkpObservation Implementation Guide](https://hl7norway.github.io/VkpObservation/currentbuild/)

## Running IG-publisher as a local docker image

Alternatively to running the IG-publisher as a Github-Workflow you can install it locally and run it on your own hardware.

To run the Docker images, install Docker, a personal license should suffice.
[Docker](https://www.docker.com/get-started)

### Build Docker image

Build a docker image using the vscode task or command-line:

~~~bash
docker build -t [your docker image name here] .
~~~

The docker image settings is contained in the "Dockerfile" configuration file of the repo. The docker file defines how to build a docker image to run the FHIR validator, IG Publishing and SUSHI, including all dependencies. An alternative to run docker is to install these applications on your local computer, but it is easier to maintain a docker image with all dependencies installed.

### Run SUSHI

To generate an ImplementationGuide.json and a menu.xml file for IG-publisher you need to rund SUSHI. Any fsh artifacts will also be generated an placed in the fsh-generated directory as a result of this run.

~~~bash
docker run --rm -v e:\GitRepo\test-IG\master\igs\test-IG:/data thomiz/fhir-build sushi /data
~~~

After the first run, the IG-publisher will update the ImplementationGuide.json file for you, but you can not run the IG-publisher the first time around without an ImplementationGuide Resource definition.

### Run the IG-publisher

When you have created the necessary files you can run the IG-publisher to generate an actual implementation guide.

~~~bash
docker run -it --rm -v package-cache:/root/.fhir -v [ig directory]:/data [name of docker image] publisher -ig /data/ig.ini
~~~

### Publish the IG

The contents in the "output" folder can be copied into the "gh-pages" folder. As soon as the contents is checked in to the GitHub repo you should have a IG page published on your github.io site.


## Projects and documentation

* NEW 2022-01-11 [Maintain FHIR IG publication](https://confluence.hl7.org/display/FHIR/Maintaining+a+FHIR+IG+Publication)
* [FSH/SUSHI School](https://fshschool.org/docs/)
* [Guidance for FHIR IG Creation](http://build.fhir.org/ig/FHIR/ig-guidance/index.html)
* [NAV's writeup of the buildprocess](https://github.com/navikt/fhir)
* [The official HL7 auto IG builder](https://github.com/FHIR/auto-ig-builder)
* [Dockerized build image for IG publisher](https://github.com/NIH-NCPI/hl7-fhir-ig-publisher)
* [IG release pipeline walkthroug (HL7 Belgium)](https://github.com/hl7-be/fhir-ig-release-publication)
* [An important script for the GitHub workflow](https://github.com/hl7-be/tutorial_ig/tree/master/.github/workflows)
* [Docker build alternative](https://github.com/logicahealth/fhir-ig-base)
  * [The actual Docker image for download](https://hub.docker.com/r/logicahealth/fhir-ig-base)
